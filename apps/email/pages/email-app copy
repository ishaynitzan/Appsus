import { emailService } from "../services/email.service.js";
import emailFilter from "../cmps/email-filter.cmp.js";
import folderList from "../cmps/email-folder-list.cmp.js";
import emailList from "../cmps/email-list.cmp.js";
import mailPreview from "../cmps/mail-preview.cmp.js";
import compose from "../pages/email-compose.js";
import { eventBus } from "../../../js/services/event-bus.service.js";

export default {
  name: "email-app",
  components: {
    emailFilter,
    folderList,
    emailList,
    mailPreview,
    compose,
  },
  props: [],
  template: `
    <section class="email-app flex">
      <folder-list @selectFolder="setFolder" class="main-container"/>
      <section class="email-body main-container flex column">
        <email-filter :unreadMail="unread"/>
        <compose v-if="selectedFolder === 'new'"/>
        <email-list v-else-if="selectedFolder ==='all'" :emailsToShow="emailsToShow"/>
      </section>
    </section>
    `,
  data() {
    return {
      emails: null,
      unread : 0,
      selectedFolder: "all",
    };
  },
  created() {
    this.query();
    eventBus.$on("changeOpenMail", this.changeOpenMail);
  },
  methods: {
    query() {
      emailService.query().then((emails) => {
        this.emails = emails;
      }).then(()=>{
        this.unreadMail();
      });
    },
    setFolder(val) {
      this.selectedFolder = val;
      console.log(val);
    },
    changeOpenMail(id) {
      emailService.getById(id).then((email) => {
        email.isRead = !email.isRead;
        emailService.save(email);
        eventBus.$emit(`changeOpenMail-${email.id}`, email.isRead);
        this.unreadMail();
      });
    },
    unreadMail() {
      if(!this.emails)return
      const unread = this.emails.filter(email => email.isRead === false);
      this.unread = unread.length;
      console.log('this.unread',this.unread);
    },
  },
  computed: {
    emailsToShow() {
      return this.emails;
    },
  },
  destroyed() {},
  watch: {
  },
};
